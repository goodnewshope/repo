
DECLARE @date CHAR(8)
SET @date = (SELECT CONVERT(char(8), GETDATE(), 112))

DECLARE @path VARCHAR(1000)
SET @path = '\\JHPPure\DB_Backup\HPIAPP\JeffMigration\02_SQLBakupFiles\'

Declare @DiffPath varchar(1000)
set @DiffPath = '\\JHPPure\DB_Backup\HPIAPP\JeffMigration\03_SQLDiffBakFiles\'


;WITH MoveCmdCTE ( DatabaseName, MoveCmd )
          AS ( SELECT DISTINCT
                        DB_NAME(database_id) ,
                        STUFF((SELECT   ' ' + CHAR(13)+', MOVE ''' + name + ''''
                                        + CASE Type
                                            WHEN 0 THEN ' TO ''E:\Data\'
                                            ELSE ' TO ''F:\Logs\'
                                          END
                                        + REVERSE(LEFT(REVERSE(physical_name),
                                                       CHARINDEX('\',
                                                              REVERSE(physical_name),
                                                              1) - 1)) + ''''
                               FROM     sys.master_files sm1
                               WHERE    sm1.database_id = sm2.database_ID
                        FOR   XML PATH('') ,
                                  TYPE).value('.', 'varchar(max)'), 1, 1, '') AS MoveCmd
               FROM     sys.master_files sm2
  )
SELECT
	
'BACKUP DATABASE [' + name + '] TO DISK = ''' + @path + '' + name + '_' + @date + '.bak'' WITH COMPRESSION, STATS=5' as [HPIAPP BackupCmd],
'RESTORE DATABASE ['+ name + '] FROM DISK = N''' + @path + '' + name + '_' + @date + '.bak'' WITH  FILE = 1 ' + movecmdCTE.MoveCmd + ',  NORECOVERY,  NOUNLOAD, REPLACE,  STATS = 5'  as [JHPIAPPSQLPRDPB RestoreNoRecover],
'BACKUP DATABASE [' + name + '] TO  DISK =  N''' + @DiffPath + '' + name + '_' + @date + '_DIFF.bak'' WITH DIFFERENTIAL , NOFORMAT, NOINIT,  NAME = N''' + name + '-Diff Database Backup'', SKIP, NOREWIND, NOUNLOAD,  STATS = 10 ' as [HPIAPP DiffBackupCmd],
--'RESTORE DATABASE ['+ name + '] FROM  DISK = N''' + @DiffPath + '' + name + '_' + @date + '_DIFF.bak'' WITH NORECOVERY, REPLACE, STATS=5 ' + movecmdCTE.MoveCmd as RestoreDiff
'RESTORE DATABASE ['+ name + '] FROM  DISK = N''' + @DiffPath + '' + name + '_' + @date + '_DIFF.bak'' WITH  FILE = 1,  NORECOVERY,  NOUNLOAD,  STATS = 5' as [JHPIAPPSQLPRDPB RestoreDiff],
'RESTORE DATABASE ['+ name + '] WITH RECOVERY;' as [JHPIAPPSQLPRDPB RecoverDB]
FROM sys.databases d
	INNER JOIN MoveCMDCTE ON d.name = movecmdcte.databasename

WHERE 1=1
and d.name not in ('master', 'model', 'msdb', 'tempdb', 'resource', 'ReportServer', 'ReportServerTempDB', 'DBA')
--and d.name = 'Audit'
GO




/*
---- HPIAPP
--BACKUP DATABASE [Audit] TO DISK = '\\JHPPure\DB_Backup\HPIAPP\JeffMigration\02_SQLBakupFiles\Audit_20250918.bak' WITH COMPRESSION, STATS=5

---- JHPIAPPSQLPRDPB
--USE [master]
--RESTORE DATABASE [Audit] FROM DISK = N'\\JHPPure\DB_Backup\HPIAPP\JeffMigration\02_SQLBakupFiles\Audit_20250918.bak' WITH  FILE = 1  , MOVE N'Audit_data' TO N'E:\Data\Audit_Data.MDF', MOVE N'Audit_log' TO N'F:\Logs\Audit_Log.LDF',  NORECOVERY,  NOUNLOAD, REPLACE,  STATS = 5
  xxxxRESTORE DATABASE [Audit] FROM DISK = N'\\JHPPure\DB_Backup\HPIAPP\JeffMigration\02_SQLBakupFiles\Audit_20250918.bak' WITH  FILE = 1  , MOVE N'Audit_data' TO N'E:\Data\Audit_Data.MDF', MOVE N'Audit_log' TO N'F:\Logs\Audit_Log.LDF',  NORECOVERY,  NOUNLOAD, REPLACE,  STATS = 5
--GO

DFF BACK
---- HPIAPP
--BACKUP DATABASE [Audit] TO  DISK = N'\\JHPPure\DB_Backup\HPIAPP\JeffMigration\03_SQLDiffBakFiles\Audit_20250918_DIFF.bak' WITH  DIFFERENTIAL , NOFORMAT, NOINIT,  NAME = N'Audit-Full Database Backup', SKIP, NOREWIND, NOUNLOAD,  STATS = 10
  xxxxxxBACKUP DATABASE [Audit] TO  DISK = N'\\JHPPure\DB_Backup\HPIAPP\JeffMigration\03_SQLDiffBakFilesAudit_20250918_DIFF.bak'  WITH  DIFFERENTIAL , NOFORMAT, NOINIT,  NAME = N'Audit-Diff Database Backup', SKIP, NOREWIND, NOUNLOAD,  STATS = 10 
--GO



-- restore diff
---- JHPIAPPSQLPRDPB
--USE [master]
----RESTORE DATABASE [Audit] FROM  DISK = N'\\JHPPure\DB_Backup\HPIAPP\JeffMigration\02_SQLBakupFiles\Audit_20250918.bak' WITH  FILE = 1,  MOVE N'Audit_log' TO N'F:\Logs\Audit_Log.LDF',  NORECOVERY,  NOUNLOAD,  STATS = 5
--RESTORE DATABASE [Audit] FROM  DISK = N'\\JHPPure\DB_Backup\HPIAPP\JeffMigration\03_SQLDiffBakFiles\Audit_20250918_DIFF.bak' WITH  FILE = 1,  NORECOVERY,  NOUNLOAD,  STATS = 5
  RESTORE DATABASE [Audit] FROM  DISK = N'\\JHPPure\DB_Backup\HPIAPP\JeffMigration\03_SQLDiffBakFilesAudit_20250918_DIFF.bak'  WITH  FILE = 1,  NORECOVERY,  NOUNLOAD,  STATS = 5



---- JHPIAPPSQLPRDPB
--RESTORE DATABASE [Audit] WITH RECOVERY
  RESTORE DATABASE [Audit]  WITH RECOVERY;
--GO
*/
